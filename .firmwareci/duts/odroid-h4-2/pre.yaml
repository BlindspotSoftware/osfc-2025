pre-stage:
  - cmd: newdutctl
    name: Shutdown the DUT.
    parameters:
      agent: "[[attributes.dutctl]]:1024"
      device: odroid
      command: power
      args: ["off"]

  - cmd: newdutctl
    name: Flash the provided binary.
    parameters:
      agent: "[[attributes.dutctl]]:1024"
      device: odroid
      command: flash
      args: [write, "[[input.Binary]]"]

  - cmd: pikvm
    name: Mount OS Image via PiKVM
    parameters:
      command: image
      host: "[[attributes.pikvm]]"
      auth:
        username: demo
        password: demo
      image:
        path: "[[storage.OSImage]]/nixos.img"

  - cmd: sleep
    name: Wait for the DUT to settle
    parameters:
      duration: 5s

  - cmd: newdutctl
    name: Turn the DUT on
    parameters:
      agent: "[[attributes.dutctl]]:1024"
      device: odroid
      command: power
      args: ["on"]
    options:
      timeout: 2m

  - cmd: ping
    name: Wait for the device to become online.
    options:
      timeout: 4m
    parameters:
      host: "[[attributes.host]]"
      port: 22
      proxy:
        type: ssh
        host: "[[attributes.dutctl]]"
        port: 22
        ssh:
          user: oscar
          identity_file: /root/.ssh/fwci
