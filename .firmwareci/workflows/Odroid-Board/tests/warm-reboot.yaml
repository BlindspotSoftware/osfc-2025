name: Warm Reboot Test
description: Flash the provided firmware binary and do multiple warm reboots.

defaults:
  transport: &transport
    proto: ssh
    options:
      host: "[[attributes.host]]"
      user: root
      identity_file: /root/.ssh/fwci
      jump_host:
        host: "[[attributes.dutctl]]"
        user: oscar
        identity_file: /root/.ssh/fwci

stages:
  - name: Reboot 1
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 2
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 3
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 4
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 5
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 6
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 7
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 8
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 9
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Reboot 10
    steps:
      - cmd: newdutctl
        name: Turn the DUT off
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["off"]
        options:
          timeout: 2m

      - cmd: newdutctl
        name: Turn the DUT on
        parameters:
          agent: "[[attributes.dutctl]]:1024"
          device: odroid
          command: power
          args: ["on"]
        options:
          timeout: 2m

      - cmd: ping
        name: Wait for the device to become online.
        options:
          timeout: 4m
        parameters:
          host: "[[attributes.host]]"
          proxy:
            type: ssh
            host: "[[attributes.dutctl]]"
            port: 22
            ssh:
              user: oscar
              identity_file: /root/.ssh/fwci

  - name: Shutdown
    steps:
      - cmd: cmd
        name: Power off device
        transport: *transport
        parameters:
          executable: shutdown
          args: ["now"]
