name: Check PCI Devices
description: Flash the provided firmware binary and check if the PCI devices are detected.

defaults:
  transport: &transport
    proto: ssh
    options:
      host: "[[attributes.host]]"
      user: root
      identity_file: /root/.ssh/fwci
      jump_host:
        host: "[[attributes.dutctl]]"
        user: oscar
        identity_file: /root/.ssh/fwci

stages:
  - name: Boot Test
    steps:
      - cmd: cmd
        name: Check Audio Device
        transport: *transport
        parameters:
          executable: lspci
          expect:
            - regex: "Multimedia audio controller: Intel Corporation Alder Lake-N PCH High Definition Audio Controller"

      - cmd: cmd
        name: Check SATA Controller
        transport: *transport
        parameters:
          executable: lspci
          expect:
            - regex: "SATA controller: ASMedia Technology Inc. ASM1064 Serial ATA Controller"

      - cmd: cmd
        name: Check RAM Controller
        transport: *transport
        parameters:
          executable: lspci
          expect:
            - regex: "RAM memory: Intel Corporation Alder Lake-N PCH Shared SRAM"

      - cmd: cmd
        name: Check Serial Bus Controller
        transport: *transport
        parameters:
          executable: lspci
          expect:
            - regex: "Serial bus controller: Intel Corporation Alder Lake-N SPI \\(flash\\) Controller"

      - cmd: cmd
        name: Power off device
        transport: *transport
        parameters:
          executable: shutdown
          args: ["now"]
